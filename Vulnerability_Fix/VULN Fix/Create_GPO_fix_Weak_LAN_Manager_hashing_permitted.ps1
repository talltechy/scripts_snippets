# Import the Group Policy module
Import-Module GroupPolicy

# Define the GPO name
$gpoName = "Upgrade CIFS Authentication Method"

# Create a new GPO
$gpo = New-GPO -Name $gpoName

# Define the registry paths and values
$registrySettings = @(
    @{
        Path = "HKLM\SYSTEM\CurrentControlSet\Control\Lsa"
        Name = "LMCompatibilityLevel"
        Type = "DWord"
        Value = 5
    },
    @{
        Path = "HKLM\SYSTEM\CurrentControlSet\Control\Lsa\MSV1_0"
        Name = "NtlmMinClientSec"
        Type = "DWord"
        Value = 0x20080000 # Example value, refer to the security guidance for the correct value
    },
    @{
        Path = "HKLM\SYSTEM\CurrentControlSet\Control\Lsa\MSV1_0"
        Name = "NtlmMinServerSec"
        Type = "DWord"
        Value = 0x20080000 # Example value, refer to the security guidance for the correct value
    }
)

# Apply the registry settings to the GPO
foreach ($setting in $registrySettings) {
    Set-GPRegistryValue -Name $gpoName -Key $setting.Path -ValueName $setting.Name -Type $setting.Type -Value $setting.Value
}

# Link the GPO to the desired OU (replace 'OU=YourOU,DC=domain,DC=com' with your actual OU)
$ou = "OU=YourOU,DC=domain,DC=com"
New-GPLink -Name $gpoName -Target $ou

Write-Output "GPO '$gpoName' has been created and linked to '$ou'. Please restart the systems for the changes to take effect."