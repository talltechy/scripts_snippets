# Import the Group Policy module
Import-Module GroupPolicy

# Function to get the default domain and OU
function Get-DefaultDomainOU {
    $domain = (Get-CimInstance Win32_ComputerSystem).Domain
    $defaultOU = "OU=DefaultOU,DC=$($domain -replace '\.', ',DC=')"
    return $defaultOU
}

# Get the default domain and OU
$defaultOU = Get-DefaultDomainOU

# Prompt the user to use the detected OU or input their own
$useDefault = Read-Host "Detected OU is '$defaultOU'. Do you want to use this OU? (Enter 'Y' for Yes, 'N' for No)"
if ($useDefault -eq 'Y' -or $useDefault -eq 'y') {
    $ou = $defaultOU
} else {
    do {
        $ou = Read-Host "Please enter the distinguished name (DN) of your organizational unit (OU)"
        if ($ou -match '^OU=[^,]+(,OU=[^,]+)*,DC=[^,]+(,DC=[^,]+)*$') {
            $isValid = $true
        } else {
            Write-Host "Invalid DN format. Please enter a valid distinguished name."
            $isValid = $false
        }
    } while (-not $isValid)
}

# Define the GPO name
$gpoName = "Upgrade CIFS Authentication Method"

# Create a new GPO
$gpo = New-GPO -Name $gpoName

# Define the registry paths and values
$registrySettings = @(
    @{
        Path = "HKLM\SYSTEM\CurrentControlSet\Control\Lsa"
        Name = "LMCompatibilityLevel"
        Type = "DWord"
        Value = 5
    },
    @{
        Path = "HKLM\SYSTEM\CurrentControlSet\Control\Lsa\MSV1_0"
        # Example value, refer to the Microsoft security guidance at https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/network-security-lan-manager-authentication-level for the correct value
        Name = "NtlmMinClientSec"
        Type = "DWord"
        Value = 0x20080000
    },
    @{
        Path = "HKLM\SYSTEM\CurrentControlSet\Control\Lsa\MSV1_0"
        Name = "NtlmMinServerSec"
        Type = "DWord"
        Value = 0x20080000 # Example value, refer to the security guidance for the correct value
    }
)

# Apply the registry settings to the GPO
    Set-GPRegistryValue -Name $gpoName -Key $setting.Path -ValueName $setting.Name -Type $setting.Type -Value $setting.Value
    Set-GPRegistryValue -Name $gpoName -Key $setting.Path -ValueName $setting.Name -Type DWord -Value $setting.Value
}

# Link the GPO to the desired OU
New-GPLink -Name $gpoName -Target $ou -LinkEnabled Yes

Write-Host "GPO '$gpoName' has been created and linked to '$ou'. Please restart the systems for the changes to take effect."